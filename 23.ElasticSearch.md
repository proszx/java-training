2.1 你们公司的ES集群，一个node一般会分配几个分片？
 6个

2.2 Elasticsearch是如何实现Master选举的？

1. Elasticsearch 的选主是 ZenDiscovery 模块负责的，主要包含 Ping（节点之间通过这个 RPC 来发现彼此）和 Unicast（单播模块包含一个主机列表以控制哪些节点需要 ping 通）这两部分；
2. 对所有可以成为 master 的节点（node.master: true）根据 nodeId 字典排序，每次选举每个节点都把自己所知道节点排一次序，然后选出第一个（第 0 位）节点，暂且认为它是 master 节点。
3. 如果对某个节点的投票数达到一定的值（可以成为 master 节点数 n/2+1）并且该节点自己也选举自己，那这个节点就是 master。否则重新选举一直到满足上述条件。
4. 补充：master 节点的职责主要包括集群、节点和索引的管理，不负责文档级别的管理；data 节点可以关闭 http 功能*。

## 2.3 你是如何做写入调优的？
### 性能测试
在一个节点的一个分片，不设置副本，测试性能
在完全默认设置上记录性能数据，作为测试的基准线
确保性能测试持续30分钟以上以确认长时间的性能；短时间的测试可能不会碰到segment合并和GC，无法确认这些因素的影响
每次基于默认基准线更改一个参数，如果性能有提升就保留设置，并基于此设置做后续的测试
### bulk使用建议
每个请求大小建议在5-15MB，逐步增大测试,当接收到EsRejectedExecutionException，就说明已经到达节点的瓶颈了，就需要减少并发或者升级硬件增加节点
当写入数据时，确保bulk请求时轮询访问所有节点，不要发送所有请求到一个结点导致这一个节点要在内存存储所有请求的数据去处理
### 优化磁盘IO
使用SSD
使用RAID 0，不用镜像备份，用replicas保证数据正确性，增大磁盘IO
使用多个磁盘给Elasticsearch访问，通过在path.data中添加
不使用远程存储，如NFS／SMB／CIFS；延时将成为性能瓶颈
### 段合并
段合并是很消耗计算资源和磁盘IO的操作，特别是出现比较大的段合并。
当出现段合并的速度落后于索引写入的速度，Elasticsearch为了避免出现堆积的段数量爆发，会降低单个线程的索引写入速度，并且会在INFO的log里记录“now throttling indexing“

### 
1. 如果不需要实时精确的查询结果，可以把每个索引的index.refresh_interval设置为30s，如果在导入大量的数据，可以把这个值先设置为－1，完成数据导入之后在设置回来
2. 如果在用bulk导入大量的数据，可以考虑不要副本，设置index.number_of_replicas: 0。有副本存在的时候，导入数据需要同步到副本，并且副本也要完成分析，索引和段合并的操作，影响导入性能。可以不设置副本导入数据然后在恢复副本。
3. 如果导入的文档没有唯一的ID，可以使用Elasticsearch自动生成的唯一ID
## 2.4 如何避免脑裂？

## 2.12 什么是脑裂？ 为什么脑裂?

1.网络问题：集群间的网络延迟导致一些节点访问不到master，认为master挂掉了从而选举出新的master，并对master上的分片和副本标红，分配新的主分片

2.节点负载：主节点的角色既为master又为data，访问量较大时可能会导致ES停止响应造成大面积延迟，此时其他节点得不到主节点的响应认为主节点挂掉了，会重新选取主节点。

3.内存回收：data节点上的ES进程占用的内存较大，引发JVM的大规模内存回收，造成ES进程失去响应。


脑裂问题解决方案：

1. 减少误判：discovery.zen.ping_timeout节点状态的响应时间，默认为3s，可以适当调大，如果master在该响应时间的范围内没有做出响应应答，判断该节点已经挂掉了。调大参数（如6s，discovery.zen.ping_timeout:6），可适当减少误判。
   
2. 选举触发 discovery.zen.minimum_master_nodes:1 该参数是用于控制选举行为发生的最小集群主节点数量。当备选主节点的个数大于等于该参数的值，且备选主节点中有该参数个节点认为主节点挂了，进行选举。官方建议为（n/2）+1，n为主节点个数（即有资格成为主节点的节点个数）增大该参数，当该值为2时，我们可以设置master的数量为3，这样，挂掉一台，其他两台都认为主节点挂掉了，才进行主节点选举。

3. 角色分离：即master节点与data节点分离，限制角色
   
## 2.5 Elasticsearch对于大数据量（上亿量级）的聚合如何实现？

Elasticsearch 提供的首个近似聚合是 cardinality 度量。它提供一个字段的基数，即该字段的 distinct 或者 unique 值的数目。它是基于 HLL 算法的。HLL会先对我们的输入作哈希运算，然后根据哈希运算的结果中的 bits 做概率估算从而得到基数。其特点是：可配置的精度，用来控制内存的使用（更精确 ＝ 更多内存）；小的数据集精度是非常高的；我们可以通过配置参数，来设置去重需要的固定内存使用量。无论数千还是数十亿的唯一值，内存使用量只与你配置的精确度相关。

## 2.6 ES主分片数量可以在后期更改吗？为什么？
 不可以
 因为如果数量变化了，那么所有之前路由的值都会无效，文档也再也找不到了。
## 2.7 如何监控集群状态？
Kibana 监控 Elasticsearch
## 2.8 ElasticSearch中的副本是什么？
分片(shard):因为ES是个分布式的搜索引擎, 所以索引通常都会分解成不同部分, 而这些分布在不同节点的数据就是分片. ES自动管理和组织分片, 并在必要的时候对分片数据进行再平衡分配, 所以用户基本上不用担心分片的处理细节，一个分片默认最大文档数量是20亿.

副本(replica):ES默认为一个索引创建5个主分片, 并分别为其创建一个副本分片. 也就是说每个索引都由5个主分片成本, 而每个主分片都相应的有一个copy.
所以把你的分片最大容量限制为30GB, 然后再对分片数量做合理估算. 
## 2.9 ES更新数据的执行流程？
es执行更新操作的时候，ES首先将旧的文档标记为删除状态，然后添加新的文档，旧的文档不会立即消失，但是你也无法访问，ES会在你继续添加更多数据的时候在后台清理已经标记为删除状态的文档。
## 2.10 shard里面是什么组成的？
**倒排索引**
倒排索引的结构，是非常适合用来做搜索的，Elasticsearch会为索引的每个index为analyzed的字段建立倒排索引。

**基本结构**
倒排索引包含以下几个部分：

某个关键词的doc list
某个关键词的所有doc的数量IDF（inverse document frequency）
某个关键词在每个doc中出现的次数：TF（term frequency）
某个关键词在这个doc中的次序
每个doc的长度：length norm
某个关键词的所有doc的平均长度
记录这些信息，就是为了方便搜索的效率和_score分值的计算。

**不可变性**
倒排索引写入磁盘后就是不可变的，这样有几个好处：

不需要锁，如果不更新索引，不用担心锁的问题，可以支持较高的并发能力
如果cache内存足够，不更新索引的话，索引可以一直保存在os cache中，可以提升IO性能。
如果数据不变，filter cache会一直驻留在内存。
索引数据可以压缩，节省cpu和io开销。

## 2.11 ElasticSearch中的分析器是什么？

字符过滤器
首先字符串经过过滤器（character filter），他们的工作是在表征化（注：这个词叫做断词更适合）前处理字符串。字符过滤器能够去除HTML标记，或者转化为“&”为“and”。    

分词器
下一步，分词器（tokenizer）被表征化（断词）为独立的词。一个简单的分词器（tokenizer）可以根据空格或逗号将单词分开（注：这个在中文中不适用）。

表征过滤
最后，每个词都通过所有表征过滤（token filters），他可以修改词（例如将“Quick”转为小写），去掉词（例如停用词像“a”、“and”、“the”等等），或者增加词（例如同义词像“a”、“and”、“the”等等）或者增加词（例如同义词像“jump”和“leap”）。
## 2.13 客户端在和集群连接时，如何选择特定的节点执行请求的？

客户端会连到一个负载均衡的接入点，由负载均衡定义的规则选择后端进行连接，客户端一般不主动选择特定的节点执行请求。

## 2.14 Elasticsearch中的倒排索引是什么？
单词词典（Term Dictionary）：搜索引擎的通常索引单位是单词，单词词典是由文档集合中出现过的所有单词构成的字符串集合，单词词典内每条索引项记载单词本身的一些信息以及指向“倒排列表”的指针。
倒排列表(PostingList)：倒排列表记载了出现过某个单词的所有文档的文档列表及单词在该文档中出现的位置信息及频率（作关联性算分），每条记录称为一个倒排项(Posting)。根据倒排列表，即可获知哪些文档包含某个单词。
倒排文件(Inverted File)：所有单词的倒排列表往往顺序地存储在磁盘的某个文件里，这个文件即被称之为倒排文件，倒排文件是存储倒排索引的物理文件。

## 2.15 什么是索引？索引（名词） 一个索引(index)
表名
写入一份文档到一个索引(名词)中，这个行为叫做index(动词)
elasticsearch采用Inverted index(倒排索引)来达到相同目的。

elasticsearch在默认情况下，为每个字段都做了一个倒排索引。

## 2.16 详细描述一下Elasticsearch更新和删除文档的过程

1. 删除和更新也都是写操作，但是 Elasticsearch 中的文档是不可变的，因此不 能被删除或者改动以展示其变更；

2. 磁盘上的每个段都有一个相应的.del 文件。当删除请求发送后，文档并没有真 的被删除，而是在.del 文件中被标记为删除。该文档依然能匹配查询，但是会在 结果中被过滤掉。当段合并时，在.del 文件中被标记为删除的文档将不会被写入 新段。

3. 在新的文档被创建时，Elasticsearch 会为该文档指定一个版本号，当执行更新时，旧版本的文档在.del 文件中被标记为删除，新版本的文档被索引到一个新段。旧版本的文档依然能匹配查询，但是会在结果中被过滤掉。